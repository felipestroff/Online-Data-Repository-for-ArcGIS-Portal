function tokml(_,options){if(!_.type)return"";var styleHashesArray=[];switch(_.type){case"FeatureCollection":return _.features?_.features.map(feature(options,styleHashesArray)).join(""):"";case"Feature":return feature(options,styleHashesArray)(_);default:return feature(options,styleHashesArray)({type:"Feature",geometry:_,properties:{}})}}function documentName(options){return void 0!==options.documentName?tag("name",options.documentName):""}function documentDescription(options){return void 0!==options.documentDescription?tag("description",options.documentDescription):""}function feature(options,styleHashesArray){return function(_){if(!_.properties||!geometry.valid(_.geometry))return"";var geometryString=geometry.any(_.geometry);if(!geometryString)return"";var styleDefinition="",styleReference="";if(options.simplestyle){var styleHash=hashStyle(_.properties);styleHash&&(geometry.isPoint(_.geometry)&&hasMarkerStyle(_.properties)?(-1===styleHashesArray.indexOf(styleHash)&&(styleDefinition=markerStyle(_.properties,styleHash),styleHashesArray.push(styleHash)),styleReference=tag("styleUrl","#"+styleHash)):(geometry.isPolygon(_.geometry)||geometry.isLine(_.geometry))&&hasPolygonAndLineStyle(_.properties)&&(-1===styleHashesArray.indexOf(styleHash)&&(styleDefinition=polygonAndLineStyle(_.properties,styleHash),styleHashesArray.push(styleHash)),styleReference=tag("styleUrl","#"+styleHash)))}return styleDefinition+tag("Placemark",name(_.properties,options)+description(_.properties,options)+extendeddata(_.properties)+timestamp(_.properties,options)+geometryString+styleReference)}}function name(_,options){return _[options.name]?tag("name",encode(_[options.name])):""}function description(_,options){return _[options.description]?tag("description",encode(_[options.description])):""}function timestamp(_,options){return _[options.timestamp]?tag("TimeStamp",tag("when",encode(_[options.timestamp]))):""}var geometry={Point:function(_){return tag("Point",tag("coordinates",_.coordinates.join(",")))},LineString:function(_){return tag("LineString",tag("coordinates",linearring(_.coordinates)))},Polygon:function(_){if(!_.coordinates.length)return"";var outer=_.coordinates[0],inner=_.coordinates.slice(1),outerRing=tag("outerBoundaryIs",tag("LinearRing",tag("coordinates",linearring(outer)))),innerRings=inner.map((function(i){return tag("innerBoundaryIs",tag("LinearRing",tag("coordinates",linearring(i))))})).join("");return tag("Polygon",outerRing+innerRings)},MultiPoint:function(_){return _.coordinates.length?tag("MultiGeometry",_.coordinates.map((function(c){return geometry.Point({coordinates:c})})).join("")):""},MultiPolygon:function(_){return _.coordinates.length?tag("MultiGeometry",_.coordinates.map((function(c){return geometry.Polygon({coordinates:c})})).join("")):""},MultiLineString:function(_){return _.coordinates.length?tag("MultiGeometry",_.coordinates.map((function(c){return geometry.LineString({coordinates:c})})).join("")):""},GeometryCollection:function(_){return tag("MultiGeometry",_.geometries.map(geometry.any).join(""))},valid:function(_){return _&&_.type&&(_.coordinates||"GeometryCollection"===_.type&&_.geometries&&_.geometries.every(geometry.valid))},any:function(_){return geometry[_.type]?geometry[_.type](_):""},isPoint:function(_){return"Point"===_.type||"MultiPoint"===_.type},isPolygon:function(_){return"Polygon"===_.type||"MultiPolygon"===_.type},isLine:function(_){return"LineString"===_.type||"MultiLineString"===_.type}};function linearring(_){return _.map((function(cds){return cds.join(",")})).join(" ")}function extendeddata(_){return tag("ExtendedData",pairs(_).map(data).join(""))}function data(_){return tag("Data",tag("value",encode(_[1])),[["name",encode(_[0])]])}function hasMarkerStyle(_){return!!(_["marker-size"]||_["marker-symbol"]||_["marker-color"])}function markerStyle(_,styleHash){return tag("Style",tag("IconStyle",tag("Icon",tag("href",iconUrl(_))))+iconSize(_),[["id",styleHash]])}function iconUrl(_){var size=_["marker-size"]||"medium",symbol=_["marker-symbol"]?"-"+_["marker-symbol"]:"",color=(_["marker-color"]||"7e7e7e").replace("#","");return"https://api.tiles.mapbox.com/v3/marker/pin-"+size.charAt(0)+symbol+"+"+color+".png"}function iconSize(_){return tag("hotSpot","",[["xunits","fraction"],["yunits","fraction"],["x",.5],["y",.5]])}function hasPolygonAndLineStyle(_){for(var key in _)if({stroke:!0,"stroke-opacity":!0,"stroke-width":!0,fill:!0,"fill-opacity":!0}[key])return!0}function polygonAndLineStyle(_,styleHash){var lineStyle=tag("LineStyle",[tag("color",hexToKmlColor(_.stroke,_["stroke-opacity"])||"ff555555")+tag("width",void 0===_["stroke-width"]?2:_["stroke-width"])]),polyStyle="";return(_.fill||_["fill-opacity"])&&(polyStyle=tag("PolyStyle",[tag("color",hexToKmlColor(_.fill,_["fill-opacity"])||"88555555")])),tag("Style",lineStyle+polyStyle,[["id",styleHash]])}function hashStyle(_){var hash="";return _["marker-symbol"]&&(hash=hash+"ms"+_["marker-symbol"]),_["marker-color"]&&(hash=hash+"mc"+_["marker-color"].replace("#","")),_["marker-size"]&&(hash=hash+"ms"+_["marker-size"]),_.stroke&&(hash=hash+"s"+_.stroke.replace("#","")),_["stroke-width"]&&(hash=hash+"sw"+_["stroke-width"].toString().replace(".","")),_["stroke-opacity"]&&(hash=hash+"mo"+_["stroke-opacity"].toString().replace(".","")),_.fill&&(hash=hash+"f"+_.fill.replace("#","")),_["fill-opacity"]&&(hash=hash+"fo"+_["fill-opacity"].toString().replace(".","")),hash}function hexToKmlColor(hexColor,opacity){if("string"!=typeof hexColor)return"";if(3===(hexColor=hexColor.replace("#","").toLowerCase()).length)hexColor=hexColor[0]+hexColor[0]+hexColor[1]+hexColor[1]+hexColor[2]+hexColor[2];else if(6!==hexColor.length)return"";var r=hexColor[0]+hexColor[1],g=hexColor[2]+hexColor[3],b=hexColor[4]+hexColor[5],o="ff";return"number"==typeof opacity&&opacity>=0&&opacity<=1&&((o=(255*opacity).toString(16)).indexOf(".")>-1&&(o=o.substr(0,o.indexOf("."))),o.length<2&&(o="0"+o)),o+b+g+r}function pairs(_){var o=[];for(var i in _)o.push([i,_[i]]);return o}